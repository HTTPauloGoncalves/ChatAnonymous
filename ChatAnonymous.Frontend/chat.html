<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Anonymous Chat</title>
    <link rel="stylesheet" href="chat.css"> <!-- Mantenha o CSS separado se quiser -->
</head>

<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-info">
                <div class="status-indicator" id="status-indicator"></div>
                <div>
                    <div class="chat-title" id="room-title">Sala</div>
                    <div class="chat-subtitle" id="room-users">Conectando...</div>
                </div>
            </div>

            <div class="chat-actions">
                <button class="action-btn" onclick="copiarLink()">Copiar Link</button>
                <button class="action-btn danger" onclick="sairSala()">Sair</button>
            </div>
        </div>

        <div class="messages-area" id="messages"></div>

        <div class="input-area">
            <input 
                type="text" 
                class="message-input" 
                id="messageInput"
                placeholder="Digite sua mensagem..."
                onkeypress="handleKeyPress(event)"
            >
            <button class="send-btn" onclick="enviarMensagem()">Enviar</button>
        </div>
    </div>

<script>
const params = new URLSearchParams(window.location.search);
const ROOM_ID = params.get("room");
const PASSWORD = params.get("password");

document.getElementById("room-title").innerText = "Sala #" + ROOM_ID;

/* -------------------------------------------  
        CONECTANDO AO SERVIDOR  
------------------------------------------- */
let ws = new WebSocket(`ws://localhost:8080/ws?room=${ROOM_ID}&password=${PASSWORD}`);

ws.onopen = () => {
    document.getElementById("room-users").innerText = "Conectado";
};

ws.onerror = () => {
    alert("Erro ao conectar ao servidor.");
};

ws.onclose = () => {
    document.getElementById("status-indicator").style.background = "#ef4444";
    document.getElementById("room-users").innerText = "Desconectado";
};

/* RECEBENDO MENSAGENS DO SERVIDOR */
ws.onmessage = (event) => {
    adicionarMensagem(event.data, false);
};

function enviarMensagem() {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();

    if (text === "" || ws.readyState !== WebSocket.OPEN) return;

    ws.send(text);
    adicionarMensagem(text, true);

    input.value = "";
}

function adicionarMensagem(text, own) {
    const messages = document.getElementById("messages");

    const div = document.createElement("div");
    div.className = own ? "message own" : "message";

    const time = new Date().toLocaleTimeString("pt-BR", {
        hour: "2-digit",
        minute: "2-digit"
    });

    div.innerHTML = `
        <div class="message-avatar">${own ? "V" : "A"}</div>
        <div class="message-content">
            <div class="message-sender">${own ? "Você" : "Anônimo"}</div>
            <div class="message-bubble">${text}</div>
            <div class="message-time">${time}</div>
        </div>
    `;

    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

function handleKeyPress(e) {
    if (e.key === "Enter") enviarMensagem();
}

function copiarLink() {
    navigator.clipboard.writeText(window.location.href);
    alert("Link copiado!");
}

function sairSala() {
    if (confirm("Deseja sair da sala?")) {
        ws.close();
        window.location.href = "./index.html";
    }
}

</script>

</body>
</html>
